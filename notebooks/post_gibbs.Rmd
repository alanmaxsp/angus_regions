---
title: "Post-Gibbs sampling summary"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 1
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(glue)
library(purrr)

source(here::here("source_functions/read_gibbs.R"))
```

# Notes & questions

From [here](https://masuday.github.io/blupf90_tutorial/vc_gs.html#generated-files)

* postgibbs thinning: "If you want to keep all the samples you have drawn, you have to put the same number as you put before. Or, you can input a multiple of the original number. For example, in this case, you can input 10, 20, 30 and so on, because the original interval was 10. If you type an inappropriate number, the program will stop with a suspicious message."
* The *independent chain size* corresponds to the number of independent samples that can be seen as independent. If the independent chain size is 3, the statistics (i.e. posterior mean and SD) are equivalently calculated using only 3 independent samples, and obviously, this is too small. This indicates whether you need more samples or not.
* Effective sample size: "At least > 10 is recommended. > 30 may be better."
* You can evaluate a sufficient interval for samples to be saved using *Independent chain size* and *Autocorrelations*. Two adjacent samples are usually highly correlated because the next sample is drawn based on the current one. When the correlation is still high between distant samples, the dependency-level is also high and the absolute values of the samples should be very similar.

---

* `postgibbs_samples` file: "The meaning of each column is:
    + Column 1: the sequential number for saved samples.
    + Column 2: the actual round in which each sample was drawn.
    + Column 3: the number of parameters.
    + Column 4 or later: actual samples ordered by the position index."

---

`find data/derived_data/gibbs_varcomp -type f -name 'last_solutions' | sed -r 's|/[^/]+$||' |sort |uniq`

nohup echo -e 'renf90.par \n 500000 0 \n 20' | /usr/local/bin/thrgibbs1f90 &> gibbs.iter1.3v7.continue.out &

---

Sampling parameters:

* 500,000 samples
* 100,000 burnin
* Keep every 100th sample

# Setup

```{r, message= FALSE, warning=FALSE}
gibbs_mce <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times = 6),
                  .y = rep(c(1, 2, 5, 7, 8, 9),
                           times = 5),
                  ~ read_gibbs_mce(iteration = .x,
                                   region = .y)) %>% 
  select(iter, dataset, everything())
```

```{r, message= FALSE, warning=FALSE}
gibbs_psd <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times = 6),
                  .y = rep(c(1, 2, 5, 7, 8, 9),
                           times = 5),
                  ~ read_gibbs_psd(iteration = .x,
                                 region = .y)) %>% 
  select(iter, dataset, everything())

```

```{r, message= FALSE, warning=FALSE}
gibbs_samples <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times = 6),
                  .y = rep(c(1, 2, 5, 7, 8, 9),
                           times = 5),
                  ~ read_gibbs_samples(iteration = .x,
                                 region = .y)) %>% 
  select(iter, dataset, everything(), -X1, -X3) %>% 
  purrr::set_names("iter", "dataset", "round", c(1:14)) %>% 
  tidyr::pivot_longer(cols = c(`1`:`14`),
                      names_to = "param") %>% 
  mutate(param = case_when(param == "1" ~ "d1d1",
                           param == "2" ~ "d1d2",
                           param == "3" ~ "d1m1",
                           param == "4" ~ "d1m2",
                           param == "5" ~ "d2d2",
                           param == "6" ~ "d2m1",
                           param == "7" ~ "d2m2",
                           param == "8" ~ "m1m1",
                           param == "9" ~ "m1m2",
                           param == "10" ~ "m2m2",
                           param == "11" ~ "mpe1mpe1",
                           param == "12" ~ "mpe2mpe2",
                           param == "13" ~ "r1r1",
                           param == "14" ~ "r2r2"),
         iter = as.character(iter))
  
``` 

# Sanity check

* Make sure every parameter has the correct number of iterations

```{r}
gibbs_samples %>% 
  group_by(iter, dataset, param) %>% 
  tally(sort = TRUE)
```

```{r}
gibbs_samples %>% 
  distinct(iter, dataset) %>% 
  arrange(dataset, iter)
```

# Monte Carlo error by time series 

```{r, echo=FALSE}
DT::datatable(gibbs_mce, rownames = FALSE)
```

# Posterior standard deviation

```{r, echo=FALSE}
DT::datatable(gibbs_psd, rownames = FALSE)
```

* Parameters with fewer than 10 independent batches

```{r}
gibbs_psd %>% 
  filter(10 > independent_batches) %>% 
  DT::datatable(rownames = FALSE)
```

* Which iterations/datasets do they come from?

```{r}
gibbs_psd %>% 
  filter(10 > independent_batches) %>% 
  distinct(iter, dataset) %>% 
  arrange(iter, dataset)
```

# Plot post-burnin and post-thinning samples {.tabset}

```{r}
plot_gibbs <-
  function(df) {
    df %>% 
      filter(param %in% c("d1d1", "d1d2", "d2d2", "m1m1", "m1m2", "m2m2", "mpe1mpe1", "mpe2mpe2")) %>% 
      ggplot(aes(x = round,
                 y = value,
                 color = param)) +
      geom_line() +
      ggsci::scale_color_ucscgb() +
      theme_classic() +
      facet_wrap(~ dataset, nrow = 3)
  }
```

## Iteration 1

```{r, fig.width=12, fig.height=10}
gibbs_samples %>% 
  filter(iter == 1) %>% 
  plot_gibbs()
```

## Iteration 2

```{r, fig.width=12, fig.height=10}
gibbs_samples %>% 
  filter(iter == 2) %>% 
  plot_gibbs()
```

## Iteration 3

```{r, fig.width=12, fig.height=10}
gibbs_samples %>% 
  filter(iter == 3) %>% 
  plot_gibbs()
```

## Iteration 4

```{r, fig.width=12, fig.height=10}
gibbs_samples %>% 
  filter(iter == 4) %>% 
  plot_gibbs()
```

## Iteration 5

```{r, fig.width=12, fig.height=10}
gibbs_samples %>% 
  filter(iter == 5) %>% 
  plot_gibbs()
```

