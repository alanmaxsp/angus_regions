---
title: "Genetic correlations & variance components from bivariate Gibbs sampling models"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: paged
    code_folding: hide
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readr)
library(dplyr)
library(tidyr)
library(glue)
library(magrittr)
library(tibble)
library(purrr)
library(ggplot2)
library(stringr)
library(rlang)
library(coda)

complete_samples <- 0

source(here::here("source_functions/calculate_heritability.R"))
source(here::here("source_functions/read_gibbs.R"))
source(here::here("source_functions/region_key.R"))

```

# Notes & questions

# Setup 

```{r, message= FALSE, warning=FALSE}
gibbs_samples <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times = 7),
                  .y = rep(c("1", "2", "3alt", "5", "7", "8", "9"),
                           times = 5),
                  ~ read_gibbs_samples(iteration = .x,
                                 region = .y)) %>% 
  select(iter, dataset, everything(), -X1, -X3) %>% 
  purrr::set_names("iter", "dataset", "round", c(1:14)) %>% 
  tidyr::pivot_longer(cols = c(`1`:`14`),
                      names_to = "param") %>% 
  mutate(param = case_when(param == "1" ~ "dir1dir1",
                           param == "2" ~ "dir1dir2",
                           param == "3" ~ "dir1mat1",
                           param == "4" ~ "dir1mat2",
                           param == "5" ~ "dir2dir2",
                           param == "6" ~ "dir2mat1",
                           param == "7" ~ "dir2mat2",
                           param == "8" ~ "mat1mat1",
                           param == "9" ~ "mat1mat2",
                           param == "10" ~ "mat2mat2",
                           param == "11" ~ "mpe1mpe1",
                           param == "12" ~ "mpe2mpe2",
                           param == "13" ~ "res1res1",
                           param == "14" ~ "res2res2"),
         iter = as.character(iter))
  
``` 

```{r}
n_samples <-
  gibbs_samples %>% 
  group_by(iter, dataset, param) %>% 
  tally(name = "n_samples") %>% 
  ungroup() %>% 
  mutate(iter = as.numeric(iter)) %>% 
  distinct(iter, dataset, n_samples) 
```

```{r, warning=FALSE, message=FALSE}
gibbs_varcomp <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times =7),
                  .y = rep(c("1", "2", "3alt", "5", "7", "8", "9"),
                           times = 5),
                  ~ read_gibbs_varcov(iteration = .x,
                                      dataset = .y))
  
```

```{r, warning=FALSE, message=FALSE}
gibbs_corr <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times = 7),
                  .y = rep(c("1", "2", "3alt", "5", "7", "8", "9"),
                           times = 5),
                  ~ read_gibbs_corr(iteration = .x,
                                    dataset = .y))
```

```{r, warning=FALSE, message=FALSE}
gibbs_h2 <-
  purrr::map2_dfr(.x = rep(c(1:5), 
                           times = 7),
                  .y = rep(c("1", "2", "3alt", "5", "7", "8", "9"),
                           times = 5),
                  ~ read_gibbs_h2(iteration = .x,
                                  dataset = .y)) 
```

```{r}
h2_sample <-
  gibbs_samples %>% 
  tidyr::pivot_wider(id_cols = c("iter", "dataset", "round"),
                     names_from = param,
                     values_from = value) %>% 
  # This is janky but it's a lot faster 
  mutate(# maternal h2
         mat1h2 = (mat1mat1/(dir1dir1+dir1mat1+mat1mat1+mpe1mpe1+res1res1)),
         mat2h2 = (mat2mat2/(dir2dir2+dir2mat2+mat2mat2+mpe2mpe2+res2res2)),
         # direct h2
         dir1h2 = (dir1dir1/(dir1dir1+dir1mat1+mat1mat1+mpe1mpe1+res1res1)),
         dir2h2 = (dir2dir2/(dir2dir2+dir2mat2+mat2mat2+mpe2mpe2+res2res2)),
         mpe1c2 = (mpe1mpe1/(dir1dir1+dir1mat1+mat1mat1+mpe1mpe1+res1res1)),
         # mpe c2
         mpe2c2 = (mpe2mpe2/(dir2dir2+dir2mat2+mat2mat2+mpe2mpe2+res2res2))) %>% 
  select(iter, dataset, round, mat1h2, mat2h2, dir1h2, dir2h2, mpe1c2, mpe2c2)
```

```{r}
rg_sample <-
  gibbs_samples %>% 
  tidyr::pivot_wider(id_cols = c("iter", "dataset", "round"),
                     names_from = param,
                     values_from = value) %>% 
  # This is janky but it's a lot faster 
  mutate(# HP dir-other dir
         rgdir1dir2 = (dir1dir2/(sqrt(dir1dir1*dir2dir2))),
         # HP mat-other mat
         rgmat1mat2 = (mat1mat2/(sqrt(mat1mat1*mat2mat2))),
         # HP dir-other mat
         rgdir1mat2 = (dir1mat2/(sqrt(dir1dir1*mat2mat2))),
         # dir-mat within region
         rgdir2mat2 = (dir2mat2/(sqrt(dir2dir2*mat2mat2))),
         rgdir1mat1 = (dir1mat1/(sqrt(dir1dir1*mat1mat1)))) %>% 
  select(iter, dataset, round, starts_with("rg"))
```

```{r}
plot_dist_grid <-
  function(df, var) {
    var <- rlang::enquo(var)
    
    df %>% 
      mutate(iter = glue("Iteration {iter}"),
             num = as.numeric(str_extract(dataset, "(?<=3v)[[:digit:]]"))) %>% 
      left_join(region_key) %>% 
      ggplot(aes(x = !!var,
                 fill = color1)) +
      geom_density() +
      theme_classic() +
      scale_fill_identity() +
      labs(x = "Estimate", 
           y = "Kernel density") +
      facet_grid(rows = vars(iter),
                 cols = vars(desc))
  }
```

```{r}
hpd <-
  h2_sample %>% 
  left_join(rg_sample) %>% 
  tidyr::pivot_longer(cols = -one_of("iter", "dataset", "round")) %>% 
  group_by(iter, dataset, name) %>% 
  tidyr::nest() %>% 
  ungroup() %>% 
  mutate(value = purrr::map(.x = data,
                            ~ .x %>% 
                              pull(value)),
         hpd_int = purrr::map(.x = value, 
                              ~ .x %>% 
                                coda::as.mcmc() %>% 
                                coda::HPDinterval()),
         hpd_lower = purrr::map_dbl(.x = hpd_int,
                                    ~ .x %>% 
                                      pluck(1)),
         hpd_upper = purrr::map_dbl(.x = hpd_int,
                                    ~ .x %>% 
                                      pluck(2))) %>% 
  select(param = name, everything(), -data, -value, -hpd_int)
```

```{r}
pivot_hpd <-
  function(which) {
    hpd %>% 
      filter(param == which) %>% 
      mutate(diff = abs(hpd_upper-hpd_lower),
             int = as.character(glue("{round(hpd_lower, digits = 3)}, {round(hpd_upper, digits = 3)} ({round(diff, digits = 3)})")),
             iter = as.character(glue("Iteration {iter}"))) %>% 
      select(iter, Dataset = dataset, int) %>% 
      tidyr::pivot_wider(names_from = iter,
                         values_from = int)
  }
```

# Heritabilities

```{r}
gibbs_h2 %>% 
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>% 
  mutate(key = if_else(key == "High Plains", "High Plains (anchor)", key)) %>% 
  select(Comparison = key, Iteration = iter, everything(), -n_samples, -dataset) %>%
  arrange(Comparison, Iteration)
```

## $$h^2_D$$

```{r}
gibbs_h2 %>% 
  group_by(key) %>% 
  summarise(`Min h2D` = min(`Direct h2`),
            `Mean h2D` = mean(`Direct h2`),
            `Max h2D` = max(`Direct h2`),
            n = n())
  
``` 

### Distribution 

```{r, fig.width=14, fig.height=8}
plot_dist_grid(df = h2_sample, var = dir2h2)
```

### HPD interval

```{r}
pivot_hpd("dir2h2")
```

## $$h^2_M$$

```{r}
gibbs_h2 %>% 
  group_by(key) %>% 
  summarise(`Min h2M` = min(`Maternal h2`),
            `Mean h2M` = mean(`Maternal h2`),
            `Max h2M` = max(`Maternal h2`),
            n = n())
  
``` 

### Distribution 

```{r, fig.width=14, fig.height=8}
plot_dist_grid(df = h2_sample, var = mat2h2)
```

### HPD interval

```{r}
pivot_hpd("mat2h2")
```

## $$c^2$$

```{r}
gibbs_h2 %>% 
  group_by(key) %>% 
  summarise(`Min c2` = min(`MPE c2`),
            `Mean c2` = mean(`MPE c2`),
            `Max c2` = max(`MPE c2`),
            n = n())
  
``` 

### Distribution 

```{r, fig.width=14, fig.height=8}
plot_dist_grid(df = h2_sample, var = mpe2c2)
```

### HPD interval

```{r}
pivot_hpd("mpe2c2")
```

# Genetic correlations

## HP direct & other direct

```{r}
gibbs_corr %>% 
  filter(stringr::str_detect(val1, "3_dir")) %>% 
  filter(stringr::str_detect(val2, "dir") & !stringr::str_detect(val2, "3_")) %>% 
  mutate(num = as.numeric(stringr::str_extract(val2, "[1-9]"))) %>% 
  left_join(region_key %>% 
              select(num, desc)) %>% 
  mutate(desc = if_else(dataset == "3v3alt", "High Plains (control)", desc)) %>% 
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>% 
  select(Comparison = desc,
         Iteration = iter,
         Correlation = corr) %>% 
  arrange(Comparison, Iteration)
```

```{r}
gibbs_corr %>% 
  filter(stringr::str_detect(val1, "3_dir")) %>% 
  filter(stringr::str_detect(val2, "dir") & !stringr::str_detect(val2, "3_")) %>% 
  mutate(num = as.numeric(stringr::str_extract(val2, "[1-9]"))) %>% 
  left_join(region_key %>% 
              select(num, desc)) %>% 
  mutate(desc = if_else(dataset == "3v3alt", "High Plains (control)", desc)) %>% 
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>% 
  select(Comparison = desc,
         Iteration = iter,
         Correlation = corr) %>% 
  group_by(Comparison) %>% 
  summarise(`Min.` = min(Correlation),
            Mean = mean(Correlation),
            `Max.` = max(Correlation),
            SD = sd(Correlation))
```

### Distribution 

```{r, fig.width=12, fig.height=8}
plot_dist_grid(df = rg_sample, var = rgdir1dir2)
```

### HPD interval

```{r}
pivot_hpd("rgdir1dir2")
```

## HP maternal & other maternal

```{r}
gibbs_corr %>% 
  filter(stringr::str_detect(val1, "3_mat")) %>% 
  filter(stringr::str_detect(val2, "mat") & !stringr::str_detect(val2, "3_")) %>% 
  mutate(num = as.numeric(stringr::str_extract(val2, "[1-9]"))) %>% 
  left_join(region_key %>% 
              select(num, desc)) %>% 
  mutate(desc = if_else(dataset == "3v3alt", "High Plains (control)", desc)) %>%
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>%
  select(Comparison = desc,
         Iteration = iter,
         Correlation = corr) %>% 
  arrange(Comparison, Iteration)
```

```{r}
gibbs_corr %>% 
  filter(stringr::str_detect(val1, "3_mat")) %>% 
  filter(stringr::str_detect(val2, "mat") & !stringr::str_detect(val2, "3_")) %>% 
  mutate(num = as.numeric(stringr::str_extract(val2, "[1-9]"))) %>% 
  left_join(region_key %>% 
              select(num, desc)) %>% 
  mutate(desc = if_else(dataset == "3v3alt", "High Plains (control)", desc)) %>%
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>%
  select(Comparison = desc,
         Iteration = iter,
         Correlation = corr) %>% 
  group_by(Comparison) %>% 
  summarise(`Min.` = min(Correlation),
            Mean = mean(Correlation),
            `Max.` = max(Correlation),
            SD = sd(Correlation))
```

### Distribution 

```{r, fig.width=12, fig.height=8}
plot_dist_grid(df = rg_sample, var = rgmat1mat2)
```

### HPD interval

```{r}
pivot_hpd("rgmat1mat2")
```

## HP direct & other maternal

```{r}
gibbs_corr %>% 
  filter(str_detect(val1, "3_dir")) %>% 
  filter(str_detect(val2, "mat") & !str_detect(val2, "3_")) %>% 
  mutate(num = as.numeric(str_extract(val2, "[1-9]"))) %>% 
  left_join(region_key %>% 
              select(num, desc)) %>%
  mutate(desc = if_else(dataset == "3v3alt", "High Plains (control)", desc)) %>%
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>%
  select(Comparison = desc,
         Iteration = iter,
         Correlation = corr) %>% 
  group_by(Comparison) %>% 
  summarise(`Min.` = min(Correlation),
            Mean = mean(Correlation),
            `Max.` = max(Correlation),
            SD = sd(Correlation))
```

### Distribution 

```{r, fig.width=12, fig.height=8}
plot_dist_grid(df = rg_sample, var = rgdir1mat2)
```

### HPD interval

```{r}
pivot_hpd("rgdir1mat2")
```

## Within-region direct & maternal

```{r}
gibbs_corr %>% 
  mutate(val1r = str_extract(val1, "^[[:alnum:]]+(?=_)"),
         val2r = str_extract(val2, "^[[:alnum:]]+(?=_)")) %>% 
  filter(val1r == val2r) %>% 
  filter(str_detect(val1, "dir")) %>% 
  filter(str_detect(val2, "mat")) %>% 
  mutate(num = as.numeric(str_extract(val2, "[1-9]"))) %>% 
  left_join(region_key %>% 
              select(num, desc)) %>%
  mutate(desc = if_else(dataset == "3v3alt", "High Plains (control)", desc)) %>%
  left_join(n_samples) %>% 
  filter(n_samples >= complete_samples) %>%
  select(Comparison = desc,
         Iteration = iter,
         Correlation = corr) %>% 
  group_by(Comparison) %>% 
  summarise(`Min.` = min(Correlation),
            Mean = mean(Correlation),
            `Max.` = max(Correlation),
            SD = sd(Correlation))
```

### Distribution 

```{r, fig.width=12, fig.height=8}
plot_dist_grid(df = rg_sample, var = rgdir2mat2)
```

### HPD interval

```{r}
pivot_hpd("rgdir2mat2")
```

# Commentary

```{r, eval=FALSE}
pivot_hpd(which = "rgmat1mat2") %>% 
  writexl::write_xlsx(here::here("test.xlsx"))
```
