---
title: "Contemporary group solutions data import"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(magrittr)
library(purrr)
library(ggplot2)
library(rlang)
library(tidylog)
library(magrittr)
library(tidylog)

source(here::here("source_functions/slice_cg_new.R"))
source(here::here("source_functions/coalesce_join.R"))
source(here::here("source_functions/three_gen.R"))
source(here::here("source_functions/ped.R"))

options(scipen=999)

```

# Notes & questions

* Traits in solutions file:
    + 1 == BW
    + 2 == WW
    + 3 == YW
* Effects in solutions file:
    + 1 == contemporary group solution (with mean in it? Maybe not fit separately?)
    + 2 == Breeding value
    + 3 == Maternal
    + 4 == Permanent environment

# Setup

```{r,message=FALSE}
# renf90.dat file generated by BLUPF90 - phenotypes + renamed CG numbers + renamed ids
# converted from wide to long format
source(here::here("source_functions/growth_pheno.R"))
```

```{r}
ped <- pull_ped(refresh = FALSE)
```

# Subset solutions file

```
awk '{if ($1 == 2 && $2 != 1 && $2 != 4) {print}}' data/raw_data/solutions > data/raw_data/ww_animal.txt
awk '{if ($1 == 3 && $2 == 2) {print}}' data/raw_data/solutions > data/raw_data/pwg_animal.txt
```

# Region key {.tabset}

* Key assigning zip codes to climate zones

## Import

```{r region_key}

region_key <-
  # Zipcode-climate zone key
  # 32,656 rows
  read_table2(here::here("data/raw_data/import_regions/zipcode_climatezones.txt"),
              col_names = c("zip", "region"),
              col_types = c("c", "n")) %>%
  # Damn it Troy
  # Regions 4 & 6 are reversed from map
  mutate(region = case_when(region == 4 ~ 6,
                            region == 6 ~ 4,
                            TRUE ~ region),
         # The way Troy wrote keys stripped leading zeroes
         # from zip codes, add them back
         zip = case_when(str_length(zip) < 5 ~ str_pad(zip,
                                                       width = 5,
                                                       side = "left",
                                                       pad = "0"),
                         TRUE ~ zip)) %>%
  # Zipcode - coordinates key
  # https://simplemaps.com/data/us-zips
  # Updated to new key 12/10 after realizing old key excluded ~2,000 zips
  # 33,099 rows
  left_join(read_csv(here::here("data/raw_data/import_regions/uszips.csv")) %>% 
      select(lat,
             lng,
             zip,
             abb = state_id)) %>%
  # Add region descriptions
  mutate(desc = case_when(region == 1 ~ "Desert (orange)",
                          region == 2 ~ "Southeast (teal)",
                          region == 3 ~ "High Plains (green)",
                          region == 4 ~ "Rainforest (red)",
                          region == 5 ~ "Arid Prairie (yellow)",
                          region == 6 ~ "Cold Desert (grey)",
                          region == 7 ~ "Forested Mountains (pink)",
                          region == 8 ~ "Fescue Belt (black)",
                          region == 9 ~ "Upper Midwest & Northeast (purple)")) %>% 
  # Random missing zip codes
  coalesce_join(tibble::tribble(~zip, ~abb,
                                "84144", "UT",
                                "83601", "ID",
                                "95314", "CA",
                                "95250", "CA",
                                "98929", "WA",
                                "98205", "WA",
                                "19542", "PA",
                                "20307", "DC",
                                "17767", "PA",
                                "17270", "PA",
                                "45145", "OH",
                                "45418", "OH",
                                "48921", "MI",
                                "42731", "KY",
                                "42084", "KY",
                                "54934", "WI",
                                "63464", "MO",
                                "54010", "WI",
                                "64192", "MO",
                                "66019", "KS",
                                "56177", "MN"),
                by = "zip")
```

# Zip codes & weigh dates {.tabset}

* Breeder zip code for each contemporary group
* Attach regions, filter out CGs missing zip codes or that don't assign to regions

## Import

```{r ww_zip, echo= TRUE}

growth_zip <-
  # Breeder zip codes, weigh dates, and "old" CG names from Lou Ann
  read_tsv(here::here("data/raw_data/import_regions/Wean_CG_Zip_WeighDt.txt"),
           col_names = c("cg_old", "zip_raw", "herd_state", "weigh_date"),
           skip = 1) %>% 
  mutate(weigh_date = lubridate::mdy(weigh_date),
         trait = "ww") %>% 
  # Foreign zips, drop
  filter(!str_detect(zip_raw, "[[:alpha:]]")) %>% 
  # Strip down to five digit zip code
  # DON'T convert from character to numeric: removes leading zeros
  # mutate: new variable 'zip' with 9899 unique values and 0% NA
  mutate(zip = case_when(str_detect(zip_raw, "[[:punct:]]") ~ str_extract(zip_raw, "^[[:digit:]]{5}"),
                         TRUE ~ zip_raw)) %>% 
  # assign to a region by zip code
  # Add lat, lng, state abbreviation, region info cols
  # join by zip
  tidylog::left_join(region_key) %>% 
  # 19,303 (from 381 zip codes) that don't match up to a region: possibly PO Boxes?
  # For now, drop
  tidylog::filter(!is.na(region)) %>% 
  # For now, drop if herd state doesn't match zip code state
  # filter: removed 9646 out of 952890 rows (1%)
  tidylog::filter(herd_state == abb) %>% 
  select(-abb)

```

# RenF90 table {.tabset}

* Key: CG number prior and post re-naming, number of animals in each CG

## Import

```{r renf90, echo = TRUE}

# Key for CG names, number of animals
renf90 <-
  readr::read_table2(here::here("data/raw_data/import_regions/renf90.tables"),
                     skip = 2,
                     col_names = c("cg_old", "n_animals", "cg_new")) %>% 
  # 4 rows with all NAs except cg_new: parsing error?
  filter(!is.na(cg_old))

```

`r scales::comma(nrow(renf90))` rows in RenF90 table

## Validation

* Contemporary group "continuity": contemporary groups can only be "subset"/split across life stages. How many contemporary groups have data for more than one trait?

```{r}

renf90 %>% 
  group_by(cg_old) %>% 
  summarise(n_traits = n()) %>% 
  ungroup %>% 
  group_by(n_traits) %>% 
  summarise(n_CGs = n())
  
```

* Do any CGs have multiple "new" names?
    + I.e., resulting from splitting a CG

```{r}

renf90 %>% 
  group_by(cg_old) %>% 
  summarise(n_names = n_distinct(cg_new)) %>% 
  ungroup() %>% 
  group_by(n_names) %>% 
  summarise(n = n())

```

# Animal solutions & phenotypes {.tabset}

* Effects in solutions file:
    + 2 == Breeding value
    + 3 == Maternal
    + 4 == Permanent environment

```{r animal_solutions, echo = TRUE}
animal_solutions <-
  read_table2(here::here("data/raw_data/import_regions/ww_animal.txt"),
              col_names = c("trait", "effect", "id_new", "solution")) %>%
  mutate(effect = case_when(effect == 2 ~ "bv_sol",
                            effect == 3 ~ "mat_sol")) %>%
  # Only WW, don't need trait
  select(-trait) %>% 
  tidyr::pivot_wider(names_from = effect,
                     values_from = solution) %>%
  # Join by trait and id_new
  # cols: id_new, bv_sol, mat_sol, weight, cg_new
  left_join(growth_pheno %>% 
              filter(trait == "ww")) %>% 
  filter(!is.na(weight)) %>% 
  select(id_new, cg_new, everything())
```

## Join

```{r animal_regions}
animal_regions <-
  # Before joining animal solutions,
  # cols: trait, cg_old, zip_raw, herd_state, weigh_date, zip, region, lat, lng, desc, n_animals, cg_new
  growth_zip %>%
  # Purpose: match up old CG name to blupf90 renamed CG
  # Slice second occurence because ww is trait 2
  slice_cg_new(trait_var = "ww", trait_order = 2) %>%
  # Purpose: add solutions from BLUPF90 output, add new IDs
  # join by cg_new, trait
  left_join(animal_solutions) %>%
  # Purpose: add et status & real registration number
  left_join(ped %>%
              select(id_new, full_reg, et_status)) %>%
  mutate(year = lubridate::year(weigh_date))
```

## Filter

* Remove records pre-1990
* Remove region 4, region 6
* Remove contemporary groups with fewer than 5 animals
* Keep only contemporary groups without phenotypic outliers (where an outlier is 3 SD above or below national mean)
* Remove single sire and single dam contemporary groups

```{r animal_regions}
animal_regions %<>%
  # Remove if assigned to region 8 but not in actual fescue belt
  mutate(helper = case_when(herd_state %in% c("CA",
                                              "WA",
                                              "OR",
                                              "PA",
                                              "NY",
                                              "WI",
                                              "NJ",
                                              "MA",
                                              "MD",
                                              "DE",
                                              "MI",
                                              "CT",
                                              "RI",
                                              "NH",
                                              "NE") & region == 8 ~ "drop",
                            TRUE ~ "keep")) %>%
  filter(helper == "keep") %>%
  # Remove ET calves
  filter(et_status == FALSE) %>%
  # Remove records prior to 1990
  filter(year >= 1990) %>% 
  # Remove region 4, 6
  filter(!region %in% c(4, 6)) %>%
  # Remove single sire, single dam CG groups
  left_join(ped %>% 
              select(full_reg, sire_id, dam_id)) %>% 
  group_by(cg_new) %>% 
  filter(n_distinct(sire_id) > 1) %>% 
  filter(n_distinct(dam_id) > 1) %>%
  mutate(n_animals = n()) %>% 
  ungroup() %>% 
  # Remove CGs with fewer than 5 animals
  filter(n_animals >= 5) %>% 
  select(-helper, -et_status) %>% 
  # Convert weight to kg
  mutate_at(vars("weight", "bv_sol", "mat_sol"), ~ measurements::conv_unit(., from = "lbs", to = "kg"))

```

### List of contemporary groups containing phenotypic outliers

```{r}
outlier_cg <-
  animal_regions %>% 
  # KEEPING only outliers in order to generate a list of black-listed contemporary group numbers
  mutate(outlier_min = mean(weight) - (sd(weight) * 3),
         outlier_max = mean(weight) + (sd(weight) * 3)) %>%
  ungroup() %>%
  mutate(outlier_drop = case_when(outlier_min > weight ~ TRUE,
                                  weight > outlier_max ~ TRUE,
                                  TRUE ~ FALSE)) %>%
  filter(outlier_drop == TRUE) %>%
  distinct(cg_new)
  
```

### Remove contemporary groups containing phenotypic outliers

```{r}
animal_regions %<>%
  anti_join(outlier_cg)
```

## Export

```{r}
animal_regions %>% 
  select(id_new, full_reg, sire_reg, dam_reg, cg_new, n_animals, region, desc, herd_state, zip, lat, lng, year, weigh_date, weight, bv_sol, mat_sol) %>% 
write_rds(here::here("data/derived_data/import_regions/animal_regions.rds"))
```

# Contemporary group solutions

```{r cg_solutions}
cg_solutions <-
  read_table2(here::here("data/raw_data/cg_sol.txt"),
              col_names = c("trait", "effect", "cg_new", "solution")) %>%
  # don't need birth weight
  filter(trait == 2) %>% 
  mutate(trait = "ww") %>% 
  # don't need effect, they're all cg_sol
  # don't need trait, they're all ww
  select(-effect)
```

## Joined

```{r cg_regions}
cg_regions <-
  growth_zip %>% 
  # Before joining cg solutions,
  # cols: trait, cg_old, zip_raw, herd_state, weigh_date, zip, region, lat, lng, desc, n_animals, cg_new
  # Slice second occurence because ww is trait 2
  slice_cg_new(trait_var = "ww", trait_order = 2) %>% 
  left_join(cg_solutions)
```


```{r cg_regions}
%>% 
  mutate(year = lubridate::year(weigh_date),
         var = "cg_sol") %>% 
  select(trait, var, value = solution, weigh_date, year, cg_old, cg_new, region, desc, herd_state, zip, lat, lng) %>% 
  right_join(n_animals_full)
```

## Export

```{r}
cg_regions %>% 
  right_join(animal_regions %>% 
               select(trait, cg_new) %>% 
               distinct()) %>% 
  write_rds(here::here("data/derived_data/import_regions/cg_regions.rds"))

```

# Commentary