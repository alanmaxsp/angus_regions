---
title: "Bivariate model (regions 2 & 3) high vs. low"
author: "Harly Durbin"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(magrittr)
library(purrr)
library(ggplot2)
library(tidylog)

source(here::here("source_functions/parse_aireml.R"))

```



# Import/setup

```{r}
sol_hilo <-
  read_table2(
    here::here("data/f90/190725_2v3/hi_lo/solutions"),
    skip = 1,
    col_names = c("region", "effect", "id_2v3", "solution")
  ) %>%
  # Trait 1 was region 2,
  # trait 2 was region 3
  mutate(region =
           case_when(region == 1 ~ "2",
                     region == 2 ~ "3")) %>%
  # Don't need CG solutions right now
  filter(effect != 1) %>% 
  left_join(
    read_table2(here::here("data/f90/190725_2v3/hi_lo/renadd02.ped"),
                col_names = FALSE) %>% 
      select(id_2v3 = X1, id_new = X10)
  ) %>% 
  mutate(analysis = "hi_lo")
```

```{r}
  
hi_lo <- read_table2(here::here("data/f90/190725_2v3/hi_lo/data.hi_lo.txt"), col_names = FALSE)

hi_lo_both <- read_table2(here::here("data/f90/190725_2v3/hi_lo/ped.hi_lo.txt"), col_names = FALSE)
```

# Notes

* Using CG solutions from the full weekly run, binned animals into top, middle, or bottom based on CG solution (Region-by-region basis)
* Then, subset test animals used in bivariate and univariate runs 
    + `r scales::comma(nrow(hi_lo_both))` total, with and without records
    + `r hi_lo %>% filter(X3 != 0) %>% distinct(X1) %>% nrow() %>% scales::comma()` Southeast/low CG with records
    + `r hi_lo %>% filter(X4 != 0) %>% distinct(X1) %>% nrow() %>% scales::comma()` High Plains/high CG with records

# Distribution of breeding values

```{r, fig.width=8, fig.height=6}
sol_hilo %>% 
  filter(effect == 2) %>% 
  ggplot(aes(
    x = solution,
    fill = forcats::as_factor(region)
  )) +
  geom_density(show.legend = FALSE) +
  facet_wrap( ~ region, 
              nrow = 2, 
              labeller = labeller(region = c("2" = "2: Southeast, low CG",
               "3" = "3: High Plains, high CG"))) +
  scale_fill_manual(
    values = c("2" = "darkslategray4",
               "3" = "springgreen3")
  ) +
  labs(title = "Distribution of breeding values, high CG vs. low CG",
       x = "Breeding value",
       y = "Kernel density") +
  theme_classic() +
    theme(
    plot.title = element_text(
      size = 20,
      face = "italic",
      margin = margin(t = 0, r = 0, b = 13, l = 0)
    ),
    axis.title = element_text(
      size = 16 
    ),
    axis.title.y = element_text(
      margin = margin(t = 0, r = 13, b = 0, l = 0)
    ),
    axis.title.x = element_text(
      margin = margin(t = 13, r = 0, b = 0, l = 0)
    ),
    axis.text = element_text(
      size = 14
    ),
    legend.text = element_text(
      size = 14
    ),
    strip.text.x = element_text(
      size = 14
    )
  )

```


# Does heritability change considering only animals from the High Plains with high CG solutions and animals from the Southeast with low CG solutions? {.tabset}

## Univariate

```{r}
parse_aireml("data/f90/190725_2v3/SE/airemlf90.SE.log", traits = c("SE")) %>% 
  filter(val1 == val2) %>% 
  select(-val2) %>% 
  mutate(val1 = str_remove(val1, "SE_")) %>% 
  spread(val1, var_cov) %>% 
  summarise(`Direct h2 (Southeast)` = dir/sum(dir, mat, mpe, res),
            `Milk h2 (Southeast)` = mat/sum(dir, mat, mpe, res),
            `MPE c2 (Southeast)` = mpe/sum(dir, mat, mpe, res),
            `Total variance` = sum(dir, mat, mpe, res))
```


```{r}

parse_aireml("data/f90/190725_2v3/HP/airemlf90.HP.log", traits = c("HP")) %>% 
  filter(val1 == val2) %>% 
  select(-val2) %>% 
  mutate(val1 = str_remove(val1, "HP_")) %>% 
  spread(val1, var_cov) %>% 
  summarise(`Direct h2 (High Plains)` = dir/sum(dir, mat, mpe, res),
            `Milk h2 (High Plains)` = mat/sum(dir, mat, mpe, res),
            `MPE c2 (High Plains)` = mpe/sum(dir, mat, mpe, res),
            `Total variance` = sum(dir, mat, mpe, res))
```


## Bivariate


```{r}
parse_aireml("data/f90/190725_2v3/airemlf90.SE_HP.log",
             traits = c("SE", "HP")) %>% 
  filter(val1 == val2) %>% 
  select(-val2) %>%  
  mutate(key = 
           case_when(
             str_detect(val1, "SE") ~ "Southeast", 
             str_detect(val1, "HP") ~ "High Plains"
             ),
         val1 = str_remove(val1, "SE_|HP_")) %>% 
  spread(val1, var_cov) %>% 
  group_by(key) %>% 
  summarise(`Direct h2` = dir/sum(dir, mat, mpe, res),
            `Milk h2` = mat/sum(dir, mat, mpe, res),
            `MPE c2` = mpe/sum(dir, mat, mpe, res), 
            `Total variance` = sum(dir, mat, mpe, res))
```


## High vs. low

* Slight change in heritability estimates
    + High plains increased for both ww direct and milk
    + Southeast decreased for both

```{r}
parse_aireml("data/f90/190725_2v3/hi_lo/airemlf90.hi_lo.log",
             traits = c("SE_lo", "HP_hi")) %>% 
  filter(val1 == val2) %>% 
  select(-val2) %>%  
  mutate(key = 
           case_when(
             str_detect(val1, "SE") ~ "Southeast (low CG)", 
             str_detect(val1, "HP") ~ "High Plains (high CG)"
             ),
         val1 = str_remove(val1, "SE_lo_|HP_hi_")) %>% 
  spread(val1, var_cov) %>% 
  group_by(key) %>% 
  summarise(`Direct h2` = dir/sum(dir, mat, mpe, res),
            `Milk h2` = mat/sum(dir, mat, mpe, res),
            `MPE c2` = mpe/sum(dir, mat, mpe, res),
            `Total variance` = sum(dir, mat, mpe, res))
```

# Genetic correlations

```{r}
read_table2(here::here("data/f90/190725_2v3/hi_lo/airemlf90.hi_lo.log"),
            skip = 9,
            n_max = 4,
            col_names = c("Southeast low CG (direct)", "High Plains high CG (direct)", "Southeast low CG (milk)", "High Plains high CG (milk)")) %>%
  mutate(rowname = colnames(.)) %>% 
  select(rowname, everything())
```

## Maternal permanent environment

```{r}
read_table2(here::here("data/f90/190725_2v3/hi_lo/airemlf90.hi_lo.log"),
            skip = 24,
            n_max = 2,
 col_names = c("Southeast low CG (MPE)", "High Plains high CG (MPE)")) %>%
  mutate(rowname = colnames(.)) %>% 
  select(rowname, everything())
```
